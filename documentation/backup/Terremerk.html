<h1>Overview of the Terremark Compute Offerings</h1>

<h2>Quick Start Guides</h2>

<ul><li><a class="internal present" href="/QuickStartTerremarkVCloudExpress.html">QuickStartTerremarkVCloudExpress</a></li>
<li><a class="internal present" href="/QuickStartTerremarkECloud.html">QuickStartTerremarkECloud</a></li>
</ul><h2>Introduction</h2>

<p>Terremark offers two services extending the VMWare vCloud API.<br />
Their cloud offers features like load balancing (Internet Service) and customization extensions that
 are not in the vCloud specification.</p>

<p>The two services Terremark offers that jclouds supports are vCloud Express (trmk-vcloudexpress) and eCloud (trmk-ecloud)</p>

<h2>Usage Notes for Terremerk vCloud</h2>

<h3>Features not yet implemented</h3>

<p>Currently, Terremark supports most of the VMware vCloud API version 0.8.
Here are the features that are not currently supported:</p>

<ul><li>undeployVApp</li>
<li>suspendVApp</li>
<li>InstantiateVAppTemplateOptions.disk(kilobytes)</li>
</ul><h3>All IP addresses are private by default</h3>

<p>You must use a vpn or connect an IP to an InternetService discussed below, if you need external access to Terremark vApps.</p>

<h3>Deploy vApp is a no-op</h3>

<p>Terremark's instantiateVApp command automatically transitions to OFF.<br />
Calling deployVApp has no effect, except to return you an in-progress task.</p>

<h2>Usage Notes for Terremerk vCloud</h2>

<h3>Default passwords</h3>

<p>All unix vApps have a default user of <code>ecloud</code> with a password that is in the
description of the vApp template. Please change these as soon as you boot your vApp.</p>




<p>Note that this will go away as of the 7-October-2010 release of eCloud where SSH key support will become available.</p>

<h3>Configuring DNS</h3>

<p>You have to configure your own dns servers.  Here's how you can do this using <a href="http://www.opendns.com">OpenDns</a> hosts:</p>

<pre><code> # prime your password 
 echo p4ssw0rd|sudo -S echo hello
 echo nameserver 208.67.222.222 |sudo tee -a /etc/resolv.conf
 echo nameserver 208.67.220.220 |sudo tee -a /etc/resolv.conf</code></pre>

<h2>Extension Guide</h2>

<p>jclouds supports all services offered by Terremark vCloud Express and most from Terremark eCloud.
Please read the <a href="https://community.vcloudexpress.terremark.com/en-us/product_docs/w/wiki/6-using-the-vcloud-express-api.aspx">vCloud Express</a>
or <a href="http://support.theenterprisecloud.com/kb/default.asp?id=601&amp;Lang=1&amp;SID=">eCloud</a> documentation to understand the concepts of
their implementation of vCloud.</p>

<p>Also review our <a class="internal present" href="/VMWareVCloud.html">vCloud Guide</a> to catch up to speed before progressing. This guide will only talk about differences.</p>

<h3>Login Details</h3>

<p>vCloud Express (and in Oct 2010 eCloud) has a ssh key mechanism.<br />
You must use ssh keys instead of passwords to login to the host via ssh.<br />
You must have a default ssh key, although you can assign any key to a machine at instantiate time.</p>

<h3>Generating Keys</h3>

<p>You must have at least a default key. The last parameter of generateKeyPairInOrg decides whether or not the keyPair will be default.</p>

<pre><code>// null for default org
TerremarkOrg org = vCloudExpressClient.findOrgNamed(null);
key = vCloudExpressClient.generateKeyPairInOrg(org.getHref(), "livetest", false);
</code></pre>

<h3>Listing Keys</h3>

<pre><code>// null for default org,  note that the private part of the key is not stored at terremark
Set&lt;KeyPair&gt; response = vCloudExpressClient.listKeyPairsInOrg(null);
	</code></pre>

<h3>Password management</h3>

<ul><li>How do I determine whether a template supports changing the admin password?</li>
</ul><p>Rule of thumb is you can in Windows and you can't in UNIX.</p>

<pre><code>// nulls will look in the default org and catalog
TerremarkCatalogItem item = client.findCatalogItemInOrgCatalogNamed(null, null, "template name");

CustomizationParameters customizationOptions = client.getCustomizationOptions(item.getCustomizationOptions().getHref());
if (customizationOptions.canCustomizePassword())
         // you can set it</code></pre>

<ul><li>If I can't customize the password, what is it?</li>
</ul><p>This is listed in the <code>description</code> of the VCloudExpressVAppTemplate.
Here's is how you can get the description:</p>

<pre><code>// the vAppTemplateId tends to be the same as the itemId, but just in case, convert
TerremarkCatalogItem item = client.findCatalogItemInOrgCatalogNamed(null, null, "Ubuntu 8.04 LTS (x86)");

String description = client.getVAppTemplate(item.getHref()).getDescription();</code></pre>

<h3>Instantiating vApp Templates</h3>

<ul><li>Instantiate vApp template automatically calls deploy</li>
</ul><p>To make use of a vApp, you must first instantiate it, then deploy it, finally power it on.
 In Terremark, instantiation automatically transitions to deploy.<br />
Even though this happens, you need to call deploy as it will return the task, which you can poll until the process is finished.</p>

<pre><code>    // lookup the datacenter you are deploying into, nulls for default
    vdc = clent.findVDCInOrgNamed(null, null);

    // instantiate, noting vApp returned has minimal details: id, name, location
    VCloudExpressVApp vApp = client.instantiateVAppTemplateInVDC(vdc.getHref(), vAppTemplate.getHref(), serverName);

    // In Terremark, instantiate implies deploy. Execute this to get a reference to that task.
    Task deployTask = client.deployVApp(vApp.getHref());
    
    // this object will loop up to 5 minutes for any task to complete on apply()
    RetryablePredicate&lt;String&gt; taskTester = new RetryablePredicate&lt;String&gt;(new TaskSuccess(context
             .getAsyncApi()), 300, 10, TimeUnit.SECONDS);

   // block until deployment task shows success
   if (!taskTester.apply(deployTask.getHref()) 
        throw new Exception("could not deploy "+vApp.getHref());

  // turn on vApp
   Task onTask = client.powerOnVApp(vApp.getHref());

   // block until poweron task shows success
   if (!taskTester.apply(onTask.getHref())) 
        throw new Exception("could not turn on "+vApp.getHref());</code></pre>

<ul><li>How do I set the size of my boot drive?</li>
</ul><p>You can't. You can only customize the processorCount and memory size of a vApp.
However, you can add disks after the instantiate call, and before the deploy one.</p>

<ul><li>How do I set the processor count and memory size of my vApp?</li>
</ul><p>Unless you specify otherwise, cpu count and memory size will be 1 and 512m respectively.<br />
You can change this by adding an options object to your instantiate command.<br />
Static import <code>processorCount</code> or <code>memory</code> and pass it as the last argument to instantiateVApp.</p>

<p>Note that you should guard this with a query to <code>getComputeOptionsOfCatalogItem</code> to ensure you don't pass an unsupported combination.</p>

<pre><code>import static org.jclouds.vcloud.terremark.options.TerremarkInstantiateVAppTemplateOptions.Builder. processorCount;

...

vApp = client.instantiateVAppTemplateInVDC(vdc.getHref(), vAppTemplate.getHref(), serverName, processorCount(2).memory(1024));</code></pre>

<ul><li>How do I assign a ssh key to a unix host?</li>
</ul><p>You will want to assign a ssh key in order to login to a unix machine you instantiate.  Do this through an instantiation option.</p>

<pre><code>import static org.jclouds.vcloud.terremark.options.TerremarkInstantiateVAppTemplateOptions.Builder.sshKeyFingerprint;

vApp = client.instantiateVAppTemplateInVDC(vdc.getHref(), vAppTemplate.getHref(), serverName, sshKeyFingerprint(key.getFingerPrint()));</code></pre>

<ul><li>How do I set the admin password when instantiating a vApp</li>
</ul><p>jclouds syntax has required parameters followed by an options bundle.
In Terremark vCloud, the option you want is <code>withPassword()</code>.<br />
Static import this method and pass it as the last argument to instantiateVApp.<br />
Note that if a password is sent and not supported, it is quietly ignored.</p>

<pre><code>import static org.jclouds.vcloud.terremark.options.TerremarkInstantiateVAppTemplateOptions.Builder.withPassword;

...
      vApp = client.instantiateVAppTemplateInVDC(vdc.getHref(), vAppTemplate.getHref(), serverName, withPassword("robotsarefun"));</code></pre>

<h3>Configuring vApps</h3>

<p>Note that your vApp must be off before you can configure it.  You can configure multiple items at the same time.</p>

<ul><li>How do I change the name of my vApp?</li>
</ul><pre><code>import static org.jclouds.vcloud.terremark.domain.VAppConfiguration.Builder.changeNameTo;
...

   Task task = client.configureVApp(vApp, changeNameTo("eduardo"));</code></pre>

<ul><li>How do I change the number of processors in my vApp?</li>
</ul><pre><code>import static org.jclouds.vcloud.terremark.domain.VAppConfiguration.Builder.changeProcessorCountTo;
...

   Task task = client.configureVApp(vApp, changeProcessorCountTo(2));</code></pre>

<ul><li>How do I change the amount of memory in my vApp?</li>
</ul><pre><code>import static org.jclouds.vcloud.terremark.domain.VAppConfiguration.Builder.changeMemoryTo;
...

Task task = client.configureVApp(vApp, changeMemoryTo(1024));</code></pre>

<ul><li>How do I add a disk to my vApp?</li>
</ul><pre><code>import static org.jclouds.vcloud.terremark.domain.VAppConfiguration.Builder.addDisk;
...
   Task task = client.configureVApp(vApp, addDisk(1048576));</code></pre>

<ul><li>How do I delete a disk from my vApp?</li>
</ul><p>In order to delete a disk, you first need to figure out which one you want to delete.<br />
Get a reference to your vApp and select disks from it.  You cannot delete the system disk (address 0).</p>

<pre><code>import static org.jclouds.vcloud.terremark.domain.VAppConfiguration.Builder.deleteDiskWithAddressOnParent;
...

// extract the disks on the vApp sorted by addressOnParent
List&lt;ResourceAllocation&gt; disks = Lists.newArrayList(vApp.getResourceAllocationByType()
          .get(ResourceType.DISK_DRIVE));
 
// delete the second disk
Task task = client.configureVApp(vApp, deleteDiskWithAddressOnParent(disks.get(1).getAddressOnParent()));
</code></pre>

<h3>IP Addresses</h3>

<p>Terremark vApps always have private IP addresses by default.<br />
You can go to the console and VPN into the network associated with your vApp.
Otherwise, you'll need to setup an Internet Service as described in the
<a href="https://community.vcloudexpress.terremark.com/en-us/product_docs/w/wiki/6-using-the-vcloud-express-api.aspx">manual</a>.</p>

<h3>Public Access to the vApp</h3>

<p>Using the Terremark console, you can get VPN access to your vApp.<br />
If you wish the SSH or connect via HTTP, you need to create an Internet Service.<br />
Here's how:</p>

<pre><code>// lookup the datacenter you are deploying into, nulls for default
vdc = clent.findVDCInOrgNamed(null, null);

// add a Internet service so you can ssh outside the vpn, noting ecloud and vcloud express are slightly different
PublicIpAddress ip;
if (client instanceof TerremarkVCloudExpressClient) {
  is = TerremarkVCloudExpressClient.class.cast(client).addInternetServiceToVDC(
           vdc.getHref(), "SSH", Protocol.TCP, 22);
  ip = is.getPublicIpAddress();
} else {
  ip = TerremarkECloudClient.class.cast(client).activatePublicIpInVDC(
          vdc.getHref());
  is = tmClient.addInternetServiceToExistingIp(ip.getId(), "SSH", Protocol.TCP, 22);
}
//get the IP of the public internet service
publicIp = ip.getAddress();

// connect the vApp's internal ip:22 to the internet service
Node  node = client.addNode(is.getHref(), Iterables.getLast(vApp.getNetworkToAddresses().values()),
         vApp.getName() + "-SSH", 22);

// If you want, add a service and node for HTTP
is = client.addInternetServiceToExistingIp(publicIp.getHref(), "HTTP",
      Protocol.HTTP, 80)
node = client.addNode(is.getHref(), Iterables.getLast(vApp.getNetworkToAddresses().values()),
      vApp.getName() + "-HTTP", 80);

// Everything is setup!
System.out.printf("you can now connect to ssh://%s:22%n", publicIp.getHostAddress());
System.out.printf("when you start a webserver it will be at http://%s%n", publicIp.getHostAddress());
</code></pre>

<ul><li>How do I allocate a new a public IP?</li>
</ul><p>Depending on whether you are using vCloud express or eCloud, there are slightly different ways to get a
 new public ip address.  After you have a public IP, you can assign Internet Services to it.</p>

<pre><code>Set&lt;PublicIpAddress&gt; existingIps = client.getPublicIpsAssociatedWithVDC(vdc.getHref());

   PublicIpAddress ip;
// in vCloud Express, you have to create a new internet service to get a new IP
if (client instanceof TerremarkVCloudExpressClient) {
  is = TerremarkVCloudExpressClient.class.cast(client).addInternetServiceToVDC(
           vdc.getHref(), "SSH", Protocol.TCP, 22);
  ip = is.getPublicIpAddress();
// in eCloud, there is an activate command
} else {
  ip = TerremarkECloudClient.class.cast(client).activatePublicIpInVDC(
          vdc.getHref());
}
</code></pre>

<ul><li>How do I connect my vApp to a public IP?</li>
</ul><p>You'll need to add your vApp as a Node on each InternetService associated with the public IP you wish.<br />
For example, if you want to open SSH and HTTP, you'll have to find/configure an <code>InternetService</code> on
 the public IP for each port, then add your vApp to them.</p>

<pre><code>// you only need to connect one private IP to the Internet Service.
InetAddress privateAddress = Iterables.getLast(vApp.getNetworkToAddresses().values());

// a Node is a connection to a public IP on a particular port.
Node node = tmClient
       .addNode(is.getHref(), privateAddress, vApp.getName() + "-" + port, port);
</code></pre>

<h2>Troubleshooting</h2>

<ul><li>java.lang.!IllegalStateException: you must specify the property jclouds.vcloud.defaults.network</li>
</ul><p>There can be multiple networks, and jclouds needs to know which is the default to launch vApps into.
  This can be done via specifying an additional property when connecting.<br />
The list of available networks is in the exception message.  For example:</p>

<pre><code>1) Error in custom provider, java.lang.IllegalStateException: you must specify the property jclouds.vcloud.defaults.network as one of [10.1.1.160/27, 10.1.1.192/27, 10.1.1.224/27, 10.1.1.0/28]
````

in the above, there are 4 networks to choose from.  Choose one and set it as the context property `VCloudConstants.PROPERTY_VCLOUD_DEFAULT_NETWORK`

```java
Properties overrides = new Properties();
overrides.setProperty(VCloudConstants.PROPERTY_VCLOUD_DEFAULT_NETWORK, "10.1.1.160/27");
ComputeServiceContext context = new ComputeServiceContextFactory().createContext("trmk-ecloud",USER ,PASSWORD,ImmutableSet.&lt;Module&gt; of(new JschSshClientModule()), overrides);</code></pre>

<p><code>Last Updated: 2011-05-26</code></p>